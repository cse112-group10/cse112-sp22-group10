<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: scripts/database.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: scripts/database.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// database.js
export const database = {};

const serverEnv = 'production';
const serverUrlLocal = 'http://localhost:3000';
const serverUrlProd = 'http://exploding-kitchen.us-west-1.elasticbeanstalk.com/api';
const url = (serverEnv === 'production') ? serverUrlProd : serverUrlLocal;

/**
 * Fetches the challenge list from server.
 * @returns {Promise} Resolves with the challenge list json if successful, rejects otherwise.
 */
async function loadChallengesFromServer() {
  try {
    const response = await fetch(`${url}/recipes/challenges`, {
      method: 'GET',
      headers: {
        Authorization: `bearer ${localStorage.getItem('userToken')}`,
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
    });
    const data = await response.json();
    const result = {
      challenges: data.challengesWithRecipes,
    };
    return result;
  } catch (err) {
    return err;
  }
}

/**
 * Adds a recipe to the database.
 * If a recipe of the same name already exists, does not add in the recipe.
 * This function must only be called after calling loadDB().
 * @param {JSON} recipeJSON The JSON of the recipe to add.
 * @returns {Promise} Resolves true if the recipe was successfully added, rejects otherwise.
 */
async function addRecipe(recipeJSON) {
  try {
    const response = await fetch(`${url}/recipes/`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${localStorage.getItem('userToken')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ recipe: recipeJSON }),
    });
    const result = await response.json();
    if (result.msg !== 'Successfully created a new recipe') {
      alert(result.msg);
      return false;
    }
    return true;
  } catch (err) {
    throw new Error(err);
  }
}

/**
 * Updates a recipe in the database.
 * This function must only be called after calling loadDB().
 * @param {JSON} recipeJSON The JSON of the recipe to update.
 * @returns {Promise} Resolves true if the recipe was successfully updated, rejects otherwise.
 */
async function updateRecipe(recipeJSON) {
  try {
    const response = await fetch(`${url}/recipes/${recipeJSON.recipeId}`, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${localStorage.getItem('userToken')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ recipe: recipeJSON }),
    });
    const data = await response.json();
    if (data.msg !== 'Successfully edited a recipe') {
      alert(data.msg);
      return false;
    }
    return true;
  } catch (err) {
    throw new Error(err);
  }
}

/**
 * Deletes a recipe from the database.
 * This function must only be called after calling loadDB();
 * @param {JSON} recipeJSON The JSON of the recipe to delete.
 * @returns {Promise} Resolves true if the recipe was successfully deleted, rejects otherwise.
 */
async function deleteRecipe(recipeJSON) {
  try {
    const response = await fetch(`${url}/recipes/${recipeJSON.recipeId}`, {
      method: 'DELETE',
      headers: {
        Authorization: `Bearer ${localStorage.getItem('userToken')}`,
      },
    });
    const result = await response.json();
    if (result.msg !== 'Delete successful') {
      alert(result.msg);
      return false;
    }
    return true;
  } catch (err) {
    throw new Error(err);
  }
}

/**
 * Update the server for completing a recipe
 * @param recipeJSON
 * @returns {Promise&lt;unknown>}
 */
async function completeRecipe(recipeJSON) {
  try {
    if (localStorage.getItem('userToken') === null) {
      return 'No user';
    }
    const response = await fetch(`${url}/users/completedRecipes/${recipeJSON.recipeId}`, {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      headers: {
        Authorization: `Bearer ${localStorage.getItem('userToken')}`,
      },
    });
    if (response.status === 503) {
      return 'Error';
    }
    if (response.status === 409) {
      return 'Conflict';
    }
    return 'Success';
  } catch (err) {
    throw new Error(err);
  }
}

/**
 * Gets a list of recipes that have a given spice level.
 * @param {Number} spiceLevel The spice level query between 1 and 5 inclusive.
 * @returns {Promise} Resolves with an array of recipe JSONs that match the query spice level,
 *                    rejects if spice level out of range.
 */
async function getBySpice(spiceLevel) {
  try {
    if (typeof spiceLevel !== 'number') {
      return new Error('Query was not a number!');
    } if (spiceLevel &lt; 1 || spiceLevel > 5) {
      return new Error('Spice level out of range!');
    }
    const response = await fetch(`${url}/recipes/spiceRating/${spiceLevel}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('userToken')}`,
      },
    });
    const recipe = await response.json();
    return recipe;
  } catch (err) {
    return new Error('Get recipe by spice level failed');
  }
}

/**
 * Get recipes by title.
 * @param {String} queryName The recipe name query.
 * @returns {Promise} Resolves with an array of recipe JSONs whose name contains the query,
 *                    rejects if it fails.
 */
async function getByName(query) {
  if (typeof query !== 'string') {
    return new Error('Query was not a string!');
  }
  const queryLower = query.toLowerCase();
  try {
    const recipesArray = await fetch(`${url}/recipes/searchByTitle/${queryLower}`);
    const result = await recipesArray.json();
    return result;
  } catch (err) {
    return new Error(`Could not find recipes that include ${query}`);
  }
}

/**
 * Returns a recipe json associated with the ID
 * @param {String} id The recipe id query.
 * @returns {Promise} Resolves with a recipe JSON whose id is the query,
 *                    rejects if it fails.
 */
async function getById(id) {
  try {
    if (typeof id !== 'number') {
      return new Error('Query was not a number!');
    }
    const response = await fetch(`${url}/recipeId/${id}`);
    const recipe = await response.json();
    return recipe;
  } catch (err) {
    return new Error('Get recipe by spice level failed');
  }
}

/**
 * fetch the token of the given userPayload
 * @param userPayload
 * @returns {Promise&lt;Error>}
 */
async function login(userPayload) {
  try {
    const response = await fetch(`${url}/auth/login/`, {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(userPayload), // body data type must match "Content-Type" header
    });
    const data = await response.json();
    if (data.accessToken) {
      setUserToken(data.accessToken);
    }
    return data;
  } catch (err) {
    return new Error('Password or username incorrect, please try again');
  }
}

/**
 * signup user by calling /auth/signup, and after user signed up, call login.
 * @param userPayload
 * @returns {Promise&lt;Error>}
 */
async function signup(userPayload) {
  try {
    const response = await fetch(`${url}/auth/signup/`, {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(userPayload), // body data type must match "Content-Type" header
    });
    const data = await response.json();
    if (data.accessToken) {
      setUserToken(data.accessToken);
    }
    return data;
  } catch (err) {
    return new Error('Password or username incorrect, please try again');
  }
}

/**
 * set the user access token
 * @param token
 */
function setUserToken(token) {
  localStorage.setItem('userToken', token);
}

/**
 * Simply call load challenges from server instead of doing a local storage fetch
 * @returns {JSON} The challenge list JSON
 */
async function getChallenges() {
  const challenges = await loadChallengesFromServer();
  return challenges.challenges;
}

database.addRecipe = addRecipe;
database.updateRecipe = updateRecipe;
database.deleteRecipe = deleteRecipe;
database.getBySpice = getBySpice;
database.getByName = getByName;
database.getById = getById;
database.completeRecipe = completeRecipe;
database.getChallenges = getChallenges;
database.login = login;
database.signup = signup;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChallengeBar.html">ChallengeBar</a></li><li><a href="RecipeCard.html">RecipeCard</a></li><li><a href="RecipeDisplay.html">RecipeDisplay</a></li><li><a href="RecipeUpload.html">RecipeUpload</a></li><li><a href="Router_Router.html">Router</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addCreateRecipe">addCreateRecipe</a></li><li><a href="global.html#addRecipe">addRecipe</a></li><li><a href="global.html#attachLoggedInComponents">attachLoggedInComponents</a></li><li><a href="global.html#bindCancelButton">bindCancelButton</a></li><li><a href="global.html#bindCreateRecipe">bindCreateRecipe</a></li><li><a href="global.html#bindDeleteButton">bindDeleteButton</a></li><li><a href="global.html#bindEditButton">bindEditButton</a></li><li><a href="global.html#bindEscKey">bindEscKey</a></li><li><a href="global.html#bindPopstate">bindPopstate</a></li><li><a href="global.html#bindProgressBar">bindProgressBar</a></li><li><a href="global.html#bindRecipeCard">bindRecipeCard</a></li><li><a href="global.html#bindSlider">bindSlider</a></li><li><a href="global.html#bindSubmitButton">bindSubmitButton</a></li><li><a href="global.html#calculateTime">calculateTime</a></li><li><a href="global.html#clickLogoToGoHome">clickLogoToGoHome</a></li><li><a href="global.html#completeRecipe">completeRecipe</a></li><li><a href="global.html#createCheckbox">createCheckbox</a></li><li><a href="global.html#createProgressBars">createProgressBars</a></li><li><a href="global.html#createRecipeCards">createRecipeCards</a></li><li><a href="global.html#deleteRecipe">deleteRecipe</a></li><li><a href="global.html#displaySearchCards">displaySearchCards</a></li><li><a href="global.html#getById">getById</a></li><li><a href="global.html#getByName">getByName</a></li><li><a href="global.html#getBySpice">getBySpice</a></li><li><a href="global.html#getChallenges">getChallenges</a></li><li><a href="global.html#getIngredient">getIngredient</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#loadChallengesFromServer">loadChallengesFromServer</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#onLoginFormSubmit">onLoginFormSubmit</a></li><li><a href="global.html#onSignupFormSubmit">onSignupFormSubmit</a></li><li><a href="global.html#setUserToken">setUserToken</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#sliderSpiceLevel">sliderSpiceLevel</a></li><li><a href="global.html#triggerSlider">triggerSlider</a></li><li><a href="global.html#updateRecipe">updateRecipe</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Wed Jun 08 2022 23:48:06 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
